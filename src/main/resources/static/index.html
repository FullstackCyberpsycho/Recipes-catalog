<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рецепты</title>
    <style>
        /* ===== Основные стили ===== */
        body { margin:0; font-family: Arial, sans-serif; background:#f9f9f9; }
        .container { display:flex; height:100vh; }

        /* ===== Sidebar ===== */
        .sidebar {
            width: 220px;
            background:#f4f4f4;
            padding:15px;
            overflow-y:auto;
            border-right:1px solid #ddd;
        }
        .sidebar h2 { margin-top:0; font-size:18px; margin-bottom:10px; }
        .category-scroll { display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow-y:auto; }
        .category-folder {
            padding:6px 10px;
            cursor:pointer;
            border-radius:6px;
            transition:0.2s;
        }
        .category-folder:hover, .category-folder.active { background:#009688; color:white; }

        .favorites-filter { margin-top:20px; }

        /* ===== Main ===== */
        .main-content { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; }
        .controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
        .controls input, .controls select, .controls button {
            padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:14px;
        }
        .controls button { background:#009688; color:white; border:none; cursor:pointer; transition:0.2s; }
        .controls button:hover { background:#00796b; }

        /* ===== Grid рецептов ===== */
        .recipe-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; }
        .recipe-card { background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; transition:0.2s; }
        .recipe-card:hover { transform:translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
        .recipe-card img { width:100%; height:160px; object-fit:cover; }
        .recipe-info { padding:10px; flex:1; }
        .recipe-info h3 { margin:0 0 5px 0; font-size:16px; }
        .category-badge { background:#e0e0e0; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px; }
        .difficulty-badge { font-size:12px; padding:2px 6px; border-radius:4px; margin-left:5px; color:white; }
        .diff-easy { background:#4caf50; }
        .diff-medium { background:#ff9800; }
        .diff-hard { background:#f44336; }
        .diff-unknown { background:#9e9e9e; }

        .recipe-actions { display:flex; justify-content:space-between; padding:5px 10px; border-top:1px solid #eee; }
        .recipe-actions button { border:none; background:none; cursor:pointer; font-size:16px; transition:0.2s; }
        .recipe-actions button:hover { color:#009688; }

        /* ===== Модалки ===== */
        .modal {
            display:none;
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center;
        }
        .modal-content {
            background:white; border-radius:8px; padding:20px; max-width:500px; width:90%;
            max-height:80vh; overflow-y:auto; position:relative;
        }
        .modal-close {
            position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px;
        }
        .modal input, .modal textarea, .modal select, .modal button { margin-top:8px; width:100%; padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
        .modal button { cursor:pointer; transition:0.2s; }
        .modal button:hover { opacity:0.85; }
        #imagePreview { width:100%; height:150px; object-fit:cover; margin-top:8px; border-radius:6px; display:none; }

    </style>
</head>
<body>

<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>Категории</h2>
        <div id="categoryContainer" class="category-scroll"></div>
        <div class="favorites-filter">
            <label><input type="checkbox" id="showFavoritesCheckbox"> Показать избранное</label>
        </div>
        <button id="manageCategoriesBtn" style="margin-top:15px;">Управление категориями</button>
    </aside>

    <!-- Main -->
    <main class="main-content">
        <div class="controls">
            <input type="text" id="search" placeholder="Поиск...">
            <select id="sort">
                <option value="">Сортировка</option>
                <option value="name-asc">Название А-Я</option>
                <option value="name-desc">Название Я-А</option>
                <option value="time-asc">Время ↑</option>
                <option value="time-desc">Время ↓</option>
            </select>
            <select id="filterDifficulty">
                <option value="">Сложность</option>
                <option value="EASY">Легко</option>
                <option value="MEDIUM">Средне</option>
                <option value="HARD">Сложно</option>
                <option value="UNKNOWN">Не указано</option>
            </select>
            <button id="addRecipeBtn">Добавить рецепт</button>
        </div>
        <div id="recipeList" class="recipe-grid"></div>
    </main>
</div>

<!-- ===== Модалки ===== -->
<!-- Новый/Редактировать рецепт -->
<div class="modal" id="recipeModal">
    <div class="modal-content">
        <span class="modal-close" id="closeModal">&times;</span>
        <h3 id="modalTitle"></h3>
        <input type="text" id="recipeName" placeholder="Название">
        <textarea id="recipeIngredients" placeholder="Ингредиенты" rows="2"></textarea>
        <textarea id="recipeInstructions" placeholder="Инструкции" rows="2"></textarea>
        <textarea id="recipeDescription" placeholder="Описание" rows="2"></textarea>
        <label>Сложность</label>
        <select id="recipeDifficulty">
            <option value="UNKNOWN">Не указано</option>
            <option value="EASY">Лёгко</option>
            <option value="MEDIUM">Средне</option>
            <option value="HARD">Сложно</option>
        </select>
        <input type="number" id="recipeTime" placeholder="Время приготовления (мин)">
        <input type="file" id="recipeImageFile" accept="image/*">
        <img id="imagePreview" alt="Превью изображения">
        <label><input type="checkbox" id="deleteImageCheckbox"> Удалить текущее изображение</label>
        <label>Категория</label>
        <select id="recipeCategory"></select>
        <button id="saveRecipeBtn">Сохранить</button>
    </div>
</div>

<!-- Детали рецепта -->
<div class="modal" id="detailsModal">
    <div class="modal-content">
        <span class="modal-close" id="closeDetailsModal">&times;</span>
        <h3 id="detailsTitle"></h3>
        <img id="detailsImage" style="width:100%;height:180px;object-fit:cover;border-radius:8px;margin-bottom:10px;">
        <p><strong>Категория:</strong> <span id="detailsCategory"></span></p>
        <p><strong>Сложность:</strong> <span id="detailsDifficulty"></span></p>
        <p><strong>Время:</strong> <span id="detailsTime"></span> мин</p>
        <p><strong>Ингредиенты:</strong> <span id="detailsIngredients"></span></p>
        <p><strong>Инструкции:</strong> <span id="detailsInstructions"></span></p>
        <p><strong>Описание:</strong> <span id="detailsDescription"></span></p>
    </div>
</div>

<!-- Управление категориями -->
<div class="modal" id="categoryModal">
    <div class="modal-content">
        <span class="modal-close" id="closeCategoryModal">&times;</span>
        <h3>Управление категориями</h3>
        <input type="text" id="newCategoryName" placeholder="Название категории">
        <button id="addCategoryBtn">Добавить категорию</button>
        <ul id="categoryList"></ul>
    </div>
</div>

<!-- Редактирование категории -->
<div class="modal" id="editCategoryModal">
    <div class="modal-content">
        <span class="modal-close" id="closeEditCategoryModal">&times;</span>
        <h3>Редактировать категорию</h3>
        <input type="text" id="editCategoryName" placeholder="Новое название категории">
        <button id="saveEditCategoryBtn" style="background:#4CAF50;color:#fff;">Сохранить</button>
        <button id="cancelEditCategoryBtn" style="background:#ccc;color:#000;">Отмена</button>
    </div>
</div>

<!-- Подтверждение удаления рецепта -->
<div class="modal" id="confirmDeleteModal">
    <div class="modal-content">
        <span class="modal-close" id="closeConfirmDeleteModal">&times;</span>
        <h3>Удалить рецепт?</h3>
        <p>Вы уверены, что хотите удалить этот рецепт?</p>
        <button id="confirmDeleteBtn" style="background:#f44336;color:#fff;">Удалить</button>
        <button id="cancelDeleteBtn" style="background:#ccc;color:#000;">Отмена</button>
    </div>
</div>

<!-- Подтверждение удаления категории -->
<div class="modal" id="confirmDeleteCategoryModal">
    <div class="modal-content">
        <span class="modal-close" id="closeConfirmDeleteCategoryModal">&times;</span>
        <h3>Удалить категорию?</h3>
        <p>Вы уверены, что хотите удалить эту категорию?</p>
        <button id="confirmDeleteCategoryBtn" style="background:#f44336;color:#fff;">Удалить</button>
        <button id="cancelDeleteCategoryBtn" style="background:#ccc;color:#000;">Отмена</button>
    </div>
</div>

<script>
    /* ===== JS код (Твой старый логика + адаптация под sidebar и избранное) ===== */
    const apiUrl = "http://localhost:8080/api/recipes",
          catUrl = "http://localhost:8080/api/categories",
          favUrl = "http://localhost:8080/api/recipes/favorites";
    const imageApiUrl = "http://localhost:8080/api/images";

      const recipeImageFile = document.getElementById("recipeImageFile"),
      deleteImageCheckbox = document.getElementById("deleteImageCheckbox");


    let recipes = [], favorites = [], categories = [], editId = null, showingFavorites = false;

    /* ===== DOM ===== */
    const recipeList = document.getElementById("recipeList"),
          searchInput = document.getElementById("search"),
          sortSelect = document.getElementById("sort"),
          filterDifficulty = document.getElementById("filterDifficulty"),
          addRecipeBtn = document.getElementById("addRecipeBtn"),
          manageCategoriesBtn = document.getElementById("manageCategoriesBtn"),
          showFavoritesCheckbox = document.getElementById("showFavoritesCheckbox"),

          modal = document.getElementById("recipeModal"),
          closeModal = document.getElementById("closeModal"),
          modalTitle = document.getElementById("modalTitle"),
          recipeName = document.getElementById("recipeName"),
          recipeIngredients = document.getElementById("recipeIngredients"),
          recipeInstructions = document.getElementById("recipeInstructions"),
          recipeDescription = document.getElementById("recipeDescription"),
          recipeDifficulty = document.getElementById("recipeDifficulty"),
          recipeTime = document.getElementById("recipeTime"),

          saveRecipeBtn = document.getElementById("saveRecipeBtn"),
          imagePreview = document.getElementById("imagePreview"),
          categorySelect = document.getElementById("recipeCategory"),

          categoryContainer = document.getElementById("categoryContainer"),
          categoryModal = document.getElementById("categoryModal"),
          closeCategoryModal = document.getElementById("closeCategoryModal"),
          newCategoryName = document.getElementById("newCategoryName"),
          addCategoryBtn = document.getElementById("addCategoryBtn"),
          categoryList = document.getElementById("categoryList"),

          editCategoryModal = document.getElementById("editCategoryModal"),
          editCategoryName = document.getElementById("editCategoryName"),
          saveEditCategoryBtn = document.getElementById("saveEditCategoryBtn"),
          cancelEditCategoryBtn = document.getElementById("cancelEditCategoryBtn"),
          closeEditCategoryModal = document.getElementById("closeEditCategoryModal"),

          confirmDeleteCategoryModal = document.getElementById("confirmDeleteCategoryModal"),
          confirmDeleteCategoryBtn = document.getElementById("confirmDeleteCategoryBtn"),
          cancelDeleteCategoryBtn = document.getElementById("cancelDeleteCategoryBtn"),
          closeConfirmDeleteCategoryModal = document.getElementById("closeConfirmDeleteCategoryModal");

    let editingCategoryId = null, deletingCategoryId = null, deletingRecipeId = null;

    /* ===== Функции ===== */
    function difficultyLabel(d) {
        switch(d) { case "EASY": return "Лёгко"; case "MEDIUM": return "Средне"; case "HARD": return "Сложно"; default: return "Не указано"; }
    }
    function difficultyClass(d) {
        switch(d) { case "EASY": return "diff-easy"; case "MEDIUM": return "diff-medium"; case "HARD": return "diff-hard"; default: return "diff-unknown"; }
    }

    async function uploadImage(file) {
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch(`${imageApiUrl}/upload`, { method: "POST", body: formData });
    if(!res.ok) throw new Error("Ошибка загрузки изображения");
    return await res.text(); // вернётся URL
}


    /* ===== Загрузка категорий ===== */
    async function loadCategories() {
        try {
            const res = await fetch(catUrl);
            categories = await res.json();

            // Обновляем select
            categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
            categories.forEach(c => categorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

            // Список в модалке
            categoryList.innerHTML = '';
            categories.forEach(c => {
                const li = document.createElement("li");
                li.textContent = c.name + " ";
                const editBtn = document.createElement("button");
                editBtn.textContent = "✎"; editBtn.onclick = () => showEditCategory(c.id, c.name);
                const delBtn = document.createElement("button");
                delBtn.textContent = "🗑"; delBtn.onclick = () => showDeleteCategoryModal(c.id);
                li.appendChild(editBtn); li.appendChild(delBtn);
                categoryList.appendChild(li);
            });

            renderCategoryFolders();
        } catch(e){ console.error(e); }
    }

    /* ===== Рендер sidebar категорий ===== */
    function renderCategoryFolders() {
        categoryContainer.innerHTML = '';
        const allFolder = document.createElement("div");
        allFolder.className = "category-folder" + (!showingFavorites ? " active" : "");
        allFolder.textContent = "Все";
        allFolder.onclick = () => { showingFavorites=false; document.querySelectorAll(".category-folder").forEach(f=>f.classList.remove("active")); allFolder.classList.add("active"); loadData(false,true); }
        categoryContainer.appendChild(allFolder);

        categories.forEach(c => {
            const folder = document.createElement("div");
            folder.className = "category-folder"; folder.textContent = c.name;
            folder.onclick = async () => {
                document.querySelectorAll(".category-folder").forEach(f=>f.classList.remove("active"));
                folder.classList.add("active");
                const res = await fetch(`${apiUrl}/category/${c.id}`);
                if(res.ok){ recipes = await res.json(); showingFavorites=false; renderRecipes(); }
            }
            categoryContainer.appendChild(folder);
        });
    }

    /* ===== Загрузка рецептов и избранного ===== */
    async function loadFavorites() {
        const res = await fetch(favUrl);
        favorites = res.ok ? await res.json() : [];
    }

    async function loadData(favOnly=false, sorted=false){
        showingFavorites=favOnly;
        const res=await fetch(favOnly?favUrl:apiUrl);
        let data=await res.json();

        if(sorted){
            const val=sortSelect.value;
            if(val==="name-asc") data.sort((a,b)=>a.name.localeCompare(b.name));
            else if(val==="name-desc") data.sort((a,b)=>b.name.localeCompare(a.name));
            else if(val==="time-asc") data.sort((a,b)=>(a.cookingTime||0)-(b.cookingTime||0));
            else if(val==="time-desc") data.sort((a,b)=>(b.cookingTime||0)-(a.cookingTime||0));
        }

        if(favOnly) favorites=data; else recipes=data;
        renderRecipes();
    }

    /* ===== Рендер рецептов ===== */
    function renderRecipes(){
        const list=showingFavorites?favorites:recipes;
        const search=(searchInput.value||"").toLowerCase();
        const filtered=list.filter(r=>(r.name||"").toLowerCase().includes(search));
        recipeList.innerHTML="";
        if(!filtered.length){ recipeList.innerHTML="<p>Рецептов не найдено</p>"; return; }

        filtered.forEach(r=>{
            const isFav=favorites.some(f=>f.id===r.id);
            const card=document.createElement("div"); card.className="recipe-card";
            card.innerHTML=`
                <img src="${r.imageUrl||'https://via.placeholder.com/300x150'}">
                <div class="recipe-info">
                    <h3>${r.name} <span class="category-badge">${r.category?.name||"—"}</span></h3>
                    <p><span>⏱ ${r.cookingTime||0} мин</span>
                    <span class="difficulty-badge ${difficultyClass(r.difficulty)}">${difficultyLabel(r.difficulty)}</span></p>
                </div>
                <div class="recipe-actions">
                    <button onclick="showDetails(${r.id})">🔍</button>
                    <button onclick="editRecipe(${r.id})">✎</button>
                    <button onclick="showDeleteRecipeModal(${r.id})">🗑</button>
                    <button onclick="toggleFavorite(${r.id})">${isFav?"⭐":"☆"}</button>
                </div>`;
            recipeList.appendChild(card);
        });
    }

    /* ===== Детали ===== */
    const detailsModal = document.getElementById("detailsModal"),
          closeDetailsModal = document.getElementById("closeDetailsModal"),
          detailsTitle = document.getElementById("detailsTitle"),
          detailsImage = document.getElementById("detailsImage"),
          detailsCategory = document.getElementById("detailsCategory"),
          detailsDifficulty = document.getElementById("detailsDifficulty"),
          detailsTime = document.getElementById("detailsTime"),
          detailsIngredients = document.getElementById("detailsIngredients"),
          detailsInstructions = document.getElementById("detailsInstructions"),
          detailsDescription = document.getElementById("detailsDescription");

    function showDetails(id){
        const r = recipes.find(x=>x.id===id) || favorites.find(x=>x.id===id);
        if(!r) return;
        detailsTitle.textContent=r.name;
        detailsImage.src=r.imageUrl||"https://via.placeholder.com/300x150";
        detailsCategory.textContent=r.category?.name||"Не указано";
        detailsDifficulty.textContent=difficultyLabel(r.difficulty);
        detailsTime.textContent=r.cookingTime||0;
        detailsIngredients.textContent=r.ingredients||"—";
        detailsInstructions.textContent=r.instructions||"—";
        detailsDescription.textContent=r.description||"—";
        detailsModal.style.display="flex";
    }
    closeDetailsModal.onclick=()=>detailsModal.style.display="none";

    /* ===== Новый/Редактировать рецепт ===== */
    /*addRecipeBtn.onclick=()=>{
        modalTitle.textContent="Новый рецепт";

       //recipeName.value=recipeIngredients.value=recipeInstructions.value=recipeDescription.value=recipeTime;//.value=recipeImage.value="";
        recipeName.value = "";
recipeIngredients.value = "";
recipeInstructions.value = "";
recipeDescription.value = "";
recipeTime.value = "";

        recipeDifficulty.value="UNKNOWN"; categorySelect.value=""; imagePreview.style.display="none"; editId=null;
        modal.style.display="flex";
    }*/

    addRecipeBtn.onclick = () => {
    modalTitle.textContent = "Новый рецепт";
    recipeName.value = "";
    recipeIngredients.value = "";
    recipeInstructions.value = "";
    recipeDescription.value = "";
    recipeTime.value = "";
    recipeDifficulty.value = "UNKNOWN";
    categorySelect.value = "";
    imagePreview.style.display = "none";
    editId = null;
    modal.style.display = "flex";
};


    closeModal.onclick=()=>modal.style.display="none";
    //recipeImage.oninput=()=>{ if(recipeImage.value){ imagePreview.src=recipeImage.value; imagePreview.style.display="block"; } else imagePreview.style.display="none"; }

    saveRecipeBtn.onclick = async () => {
    const time = parseInt(recipeTime.value);

    let imageUrl = null;
    if(editId){
        const r = recipes.find(x=>x.id===editId)||favorites.find(x=>x.id===editId);
        imageUrl = r?.imageUrl || null;
    }

    // Если стоит галка удаления
    if(deleteImageCheckbox.checked && imageUrl){
        await fetch(`${imageApiUrl}/delete?path=${encodeURIComponent(imageUrl)}`, { method: "DELETE" });
        imageUrl = null;
    }

    // Если выбрали новый файл
    if(recipeImageFile.files.length > 0){
        if(imageUrl){
            await fetch(`${imageApiUrl}/delete?path=${encodeURIComponent(imageUrl)}`, { method: "DELETE" });
        }
        imageUrl = await uploadImage(recipeImageFile.files[0]);
    }

    const data = {
        name: recipeName.value,
        ingredients: recipeIngredients.value,
        instructions: recipeInstructions.value,
        description: recipeDescription.value,
        cookingTime: isNaN(time) ? 0 : time,
        imageUrl: imageUrl,
        difficulty: (recipeDifficulty.value||"UNKNOWN").toUpperCase(),
        category: categorySelect.value ? { id: categorySelect.value } : null
    };

    if(editId)
        await fetch(`${apiUrl}/${editId}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) });
    else
        await fetch(apiUrl, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) });

    modal.style.display = "none";
    deleteImageCheckbox.checked = false;
    recipeImageFile.value = "";
    await loadData(showingFavorites,true);
    await loadFavorites();
};


    function editRecipe(id){
    const r=recipes.find(x=>x.id===id)||favorites.find(x=>x.id===id);
    if(!r) return;

    modalTitle.textContent="Редактировать рецепт";
    recipeName.value=r.name||"";
    recipeIngredients.value=r.ingredients||"";
    recipeInstructions.value=r.instructions||"";
    recipeDescription.value=r.description||"";
    recipeTime.value=r.cookingTime||"";
    recipeDifficulty.value=r.difficulty||"UNKNOWN";
    categorySelect.value=r.category?.id||"";
    imagePreview.style.display = r.imageUrl ? "block" : "none";
    if(r.imageUrl) imagePreview.src = r.imageUrl;
    deleteImageCheckbox.checked = false;
    recipeImageFile.value = "";

    editId = id;                // 👈 теперь при сохранении будет PUT
    modal.style.display="flex"; // 👈 открываем модалку
}


    /* ===== Удаление рецепта ===== */
    const confirmDeleteModal=document.getElementById("confirmDeleteModal"),
          confirmDeleteBtn=document.getElementById("confirmDeleteBtn"),
          cancelDeleteBtn=document.getElementById("cancelDeleteBtn"),
          closeConfirmDeleteModal=document.getElementById("closeConfirmDeleteModal");
    function showDeleteRecipeModal(id){ deletingRecipeId=id; confirmDeleteModal.style.display="flex"; }
   // confirmDeleteBtn.onclick=async()=>{ if(!deletingRecipeId) return; await fetch(`${apiUrl}/${deletingRecipeId}`,{method:"DELETE"}); await loadData(showingFavorites,true); await loadFavorites(); renderRecipes(); deletingRecipeId=null; confirmDeleteModal.style.display="none"; }
    confirmDeleteBtn.onclick = async () => {
    if(!deletingRecipeId) return;

    // Найдём рецепт, чтобы удалить картинку, если есть
    const r = recipes.find(x => x.id === deletingRecipeId) || favorites.find(x => x.id === deletingRecipeId);
    if(r?.imageUrl){
        await fetch(`${imageApiUrl}/delete?path=${encodeURIComponent(r.imageUrl)}`, { method:"DELETE" });
    }

    // Теперь удаляем сам рецепт
    await fetch(`${apiUrl}/${deletingRecipeId}`, { method:"DELETE" });

    confirmDeleteModal.style.display = "none";
    deletingRecipeId = null;

    // Перезагрузим список
    await loadData(showingFavorites,true);
    await loadFavorites();
    renderRecipes();
};

    cancelDeleteBtn.onclick=closeConfirmDeleteModal.onclick=()=>confirmDeleteModal.style.display="none";

    /* ===== Избранное ===== */
    async function toggleFavorite(id){
        const isFav=favorites.some(f=>f.id===id);
        await fetch(`${favUrl}/${id}`,{method:isFav?"DELETE":"POST"});
        await loadFavorites(); renderRecipes();
    }

    /* ===== События ===== */
    searchInput.oninput=renderRecipes;
    sortSelect.onchange=()=>loadData(showingFavorites,true);
    filterDifficulty.onchange=async()=>{
        const diff=filterDifficulty.value;
        if(diff){
            const res=await fetch(`${apiUrl}/sortedDifficulty/${diff}`);
            if(res.ok){ recipes=await res.json(); showingFavorites=false; renderRecipes(); }
        } else { await loadData(false,true); }
    }
    showFavoritesCheckbox.onchange=async()=>{ showingFavorites=showFavoritesCheckbox.checked; if(showingFavorites) await loadFavorites(); renderRecipes(); }
    manageCategoriesBtn.onclick=()=>categoryModal.style.display="flex";
    closeCategoryModal.onclick=()=>categoryModal.style.display="none";

    /* ===== Категории: Добавление ===== */
    addCategoryBtn.onclick=async()=>{
        const name=newCategoryName.value.trim(); if(!name) return;
        await fetch(catUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name})});
        newCategoryName.value=""; await loadCategories(); await loadData(false,true);
    }

    /* ===== Категории: Редактирование ===== */
    function showEditCategory(id,name){ editingCategoryId=id; editCategoryName.value=name; editCategoryModal.style.display="flex"; }
    cancelEditCategoryBtn.onclick=closeEditCategoryModal.onclick=()=>editCategoryModal.style.display="none";
    saveEditCategoryBtn.onclick=async()=>{
        const newName=editCategoryName.value.trim(); if(!newName) return;
        await fetch(`${catUrl}/${editingCategoryId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:newName})});
        categories=categories.map(c=>c.id===editingCategoryId?{...c,name:newName}:c);
        recipes=recipes.map(r=>r.category?.id===editingCategoryId?{...r,category:{...r.category,name:newName}}:r);
        favorites=favorites.map(r=>r.category?.id===editingCategoryId?{...r,category:{...r.category,name:newName}}:r);
        renderRecipes(); await loadCategories(); editCategoryModal.style.display="none"; editingCategoryId=null;
    }

    /* ===== Категории: Удаление ===== */
    /*function showDeleteCategoryModal(id){ deletingCategoryId=id; confirmDeleteCategoryModal.style.display="flex"; }
    cancelDeleteCategoryBtn.onclick=closeConfirmDeleteCategoryModal.onclick=()=>confirmDeleteCategoryModal.style.display="none";
    confirmDeleteBtn.onclick = async () => {
    if(!deletingRecipeId) return;
    const r = recipes.find(x=>x.id===deletingRecipeId)||favorites.find(x=>x.id===deletingRecipeId);
    if(r?.imageUrl){
        await fetch(`${imageApiUrl}/delete?path=${encodeURIComponent(r.imageUrl)}`, { method:"DELETE" });
    }
    await fetch(`${apiUrl}/${deletingRecipeId}`, { method:"DELETE" });
    confirmDeleteModal.style.display="none";
    deletingRecipeId=null;
    await loadData(showingFavorites,true);
    await loadFavorites();
};*/

function showDeleteCategoryModal(id){
    deletingCategoryId=id;
    confirmDeleteCategoryModal.style.display="flex";
}
cancelDeleteCategoryBtn.onclick = closeConfirmDeleteCategoryModal.onclick = () => confirmDeleteCategoryModal.style.display="none";

confirmDeleteCategoryBtn.onclick = async () => {
    if(!deletingCategoryId) return;
    await fetch(`${catUrl}/${deletingCategoryId}`, { method:"DELETE" });
    deletingCategoryId = null;
    confirmDeleteCategoryModal.style.display="none";
    await loadCategories();
    await loadData(false,true);
};



    /* ===== Инициализация ===== */
    (async function init(){ await loadData(false,true); await loadCategories(); await loadFavorites(); })();
</script>

</body>
</html>